/******************** (C) COPYRIGHT 2008 LUMINARY LM3S21xx ********************
;* File Name          : ENG_ERR.h
;* Author             : 张力阵
;* 电能脉冲处理函数库头文件和声明
*******************************************************************************/
//脉冲输入定义
#include "Data_types.h"
#define  POS_Watt_PLS    '0'       //正向有功
#define  POS_Var_PLS     '1'       //正向无功
#define  NEG_Watt_PLS    '2'       //反向有功
#define  NEG_Var_PLS     '3'       //反向无功

#define  UJDQ_DELAY      (64/TIMER_8MS)      //电压继电器延时40ms         定义不能超过255 否则需要改变 定时器数据类型(u8 改为 u16 或u32)
#define  ESwitch_DELAY   (160/TIMER_8MS)     //电子开关延时150ms          定义不能超过255 否则需要改变 定时器数据类型(u8 改为 u16 或u32)
                                             //ESwitch_DELAY-UJDQ_DELAY 大于 继电器触点抖动时间                         
#define  IJDQ_EN_DELAY   (120/TIMER_8MS)     //电流继电器使能信号撤销延时 定义不能超过255 否则需要改变 定时器数据类型(u8 改为 u16 或u32)
#define  IJDQ_CTL_DELAY  (200/TIMER_8MS)     //电流继电器控制信号撤销延时 定义不能超过255 否则需要改变 定时器数据类型(u8 改为 u16 或u32)
/********************************************************
* 发送数据到CAN缓冲区
* 人口: CMD 命令编号
* 人口: Len 数据长度
* 人口: Ptr 待发送数据指针
********************************************************/
void Send_Data(u16 CMD,u8 Len,u8 *Ptr);
/********************************************************
* 电流继电器定时处理
********************************************************/
void I_JDQ_Time_Pr(void);
/********************************************************
* 继电器定时处理
* 电子开关定时处理
********************************************************/
void UJDQ_ESwitch_Time_Pr(void);
/********************************************************
* 电压电流接入处理
********************************************************/
void Uin_Iin_Pr(void);                            
/********************************************************
* 电流接入处理
* 入口: Sts:0 电流旁路  Sts:1 电流接入(继电器断开) 
********************************************************/
void I_In_Out_Pr(u8 Sts);
/********************************************************
* 电压继电器都接入 u in
* 电子开关接入
* 继电器接入前先吸合电子开关 防止拉弧
* 电压通过电压继电器接入回路
********************************************************/
void UJDQ_Close_ESwitch_Close(void);
/********************************************************
* 电压继电器都接入 uin
* 电子开关都断开
* 继电器接入前先吸合电子开关 防止拉弧
********************************************************/
void UJDQ_Close_ESwitch_Open(void);
/********************************************************
* 电压继电器都断开 u out
* 电子开关接入
* 继电器接入前先吸合电子开关 防止拉弧
********************************************************/
void UJDQ_Open_ESwitch_Close(void);
/********************************************************
* 电压继电器都断开 u out
* 电子开关都断开
* 继电器接入前先吸合电子开关 防止拉弧
********************************************************/
void UJDQ_Open_ESwitch_Open(void);
/********************************************************
* 继电器控制处理
* 处理标志 在主循环中处理吸合还是断开
* Phase=0 三相 Phase=1(UA) Phase=2(UB) Phase=3(UC)
* Sts=1 吸合 Sts=0 断开 
********************************************************/
void UJDQ_Control_Pr(u8 Phase,u8 Sts);
/********************************************************
* 电子开关控制处理
* 处理标志 在主循环中处理吸合还是断开
********************************************************/
void ESwitch_Control_Pr(u8 Phase,u8 Pre,u8 Sts);
/********************************************************
* 重新开始校验
********************************************************/
void ReStart_Mea(void);
/********************************************************
* 计算被检表高频重装值和重装次数
********************************************************/
void Cal_Gp_Relaod(void);
/********************************************************
* 被检表电能误差处理模式 计算误差
********************************************************/
void ENG_ERR_MODE_Pr(void);
/********************************************************
* 计算实际应计标准电能脉冲个数
********************************************************/
void Cal_STD_ENG_CNT_VAL(void);
/********************************************************
* 接收标准表高频常数处理
********************************************************/
void Set_STD_CST_Pr(void);         
/********************************************************
* 接收校验圈数并处理
********************************************************/
void Set_N_Pr(void);
/********************************************************
* 接收误差清零处理
********************************************************/
void ERR_CLR_Pr(void);
/********************************************************
* 光电头复位处理
********************************************************/
void GDT_RST_Pr(void);          
/********************************************************
* 接收光电头对光  处理
********************************************************/
void ELEC_HEAD_RESET_Pr(void);
/********************************************************
* 选表位 挂表  处理
********************************************************/
void MTR_PLUG_Pr(void);
/********************************************************
* 对黑斑 处理        ;0退去其他试验，回到校验状态  
********************************************************/
void CATCH_HB_Pr(void);
/********************************************************
* //监视光电头脉冲处理   
* 1起动/潜动时记数 0退去其他试验，回到校验状态       
********************************************************/
void Start_Stop_Pr(void);
/********************************************************
* 脉冲合成方式  
********************************************************/
void Set_PLSHC(void);
/********************************************************
* 接收脉冲所在象限
********************************************************/
void Set_PLS_QUAD(void);                 
/********************************************************
* 喇叭开关 处理   
* 0:喇叭关  1:喇叭开      
********************************************************/
void BEEP_EN_Pr(void);
/********************************************************
* 接收校核常数走字度数  
* GMXXYYYY(0Dh) 原命令XX表位号 YYYY走字圈数  
********************************************************/
void Set_ZZ_Ds(void);      
/********************************************************
* 接收校核常数设定走字度数,准备开始走字试验 处理   
********************************************************/
void Login_Verify_Sts(void);
/********************************************************
* 开始进行走字试验 处理   
********************************************************/
void Verify_Start_Pr(void);
/********************************************************
* 接收被校表常数  处理   
********************************************************/
void Set_Mtr_Cst_Pr(void);
/********************************************************
* 光电头脉冲输入使/禁能 
* 入口: DEN  0:输入禁能 1:输入使能  
********************************************************/
void GDT_PLS_IN_DEN(u8 DEN);       
/********************************************************
* 电子脉冲输入使能/禁能 
* 入口: DEN  0:输入禁能 1:输入使能  
********************************************************/
void ELSC_PLS_IN_DEN(u8 DEN);       
/********************************************************
* 电能脉冲输入处理   
********************************************************/
void ENG_PLS_IN_Pr(void);
/********************************************************
* 时钟 需量 脉冲输入设置
********************************************************/
void CLK_XUL_PLS_IN_Pr(void);
/********************************************************
* 脉冲选择  电子脉冲还是光电头脉冲  处理   
* 0:光电头脉冲 1:电子脉冲 2:高频脉冲
********************************************************/
void PLS_SEL_Pr(void);
/********************************************************
* //计电能试验  处理   
* 0:终止    1:开始   
********************************************************/
void Cnt_ENG_Pr(void);
/********************************************************
* 清除电能计数  处理   
********************************************************/
void ENG_CLR_Pr(void);
/********************************************************
* 盘转试验 电子脉冲和光电头脉冲比较   处理   
********************************************************/
void PZ_ERR_Pr(void);
/********************************************************
* 接收脉冲和盘转比值   处理   
********************************************************/
void Set_Pzbz_Pr(void);
/********************************************************
* 接收脉冲和盘转设定比较圈数  处理   
********************************************************/
void Set_Pzzs_Pr(void);  
/********************************************************
* 复位电流旁路继电器
********************************************************/
void RST_IJDQ(void);                 
/********************************************************
* 测试命令显示8.8.8.8.8.8.8.8.
********************************************************/
void LED_TST(void);
/********************************************************
* 复位7279
********************************************************/
void RST_LED(void);
/******************************************************
* 合闸检测使能命令
******************************************************/
void Set_TZEN(void);                           
/******************************************************
* 表报警信号检测使能 
******************************************************/
void Set_MBJEN(void);                   
/******************************************************
* 单三相台设置命令
******************************************************/
void Set_TS(void);
/******************************************************
* 设置单相跳闸
******************************************************/
void Set_DXTZ(void);
/********************************************************
* 总控中心启动命令
********************************************************/
void Set_Master_Start(void);
/********************************************************
* 接收失压相别
********************************************************/
void Set_Sy_Ph(void);
/********************************************************
* 进入失压状态处理   
********************************************************/
void Login_Sy_Sts(void);
/********************************************************
* 失压试验开始  处理   
********************************************************/
void Start_Sy_Pr(void);
/********************************************************
* 选择需要测量脉冲周期和频率的脉冲 处理 
* 0:选择电子脉冲 1:选择需量周期脉冲 2:选择时钟脉冲 1:选择光电头脉冲
********************************************************/
void CYCLE_PLS_SEL_Pr(void); 
/********************************************************
* 设置电子脉冲分频系数 处理 
********************************************************/
void DIVIDE_COEF_Pr(void);
/********************************************************
* 计读脉冲法常数测试试验 处理 
* 返回被检表脉冲
********************************************************/
void MEA_MTR_CST_Pr(void);
/********************************************************
* 功耗测试 表位和相别选择 处理 
********************************************************/
void Power_Test_Pr(void);
/********************************************************
* 脉冲波形测试 处理 
********************************************************/
void MEA_PLS_CYCLE_Pr(void);
/********************************************************
* 接线方式 处理 
********************************************************/
void WIRE_TYPE_Pr(void);
/********************************************************
* 被校表脉冲输出类型选择 处理 
* 电子脉冲共高共低选择
********************************************************/
void ELEC_PLS_TYPE_Pr(void);
/********************************************************
* 设置走字脉冲数 处理 
********************************************************/
void Set_ZZ_PLS_Pr(void);
/********************************************************
* 脉冲走字试验 处理 
********************************************************/
void PLS_ZZ_Pr(void);
/********************************************************
* 预置脉冲数 处理 
********************************************************/
void ReSet_ZZ_PLS_Pr(void);      
/********************************************************
* 开始耐压试验   处理 
********************************************************/
void Start_Ny_Pr(void);
/********************************************************
* 耐压时间到 命令    处理 
********************************************************/
void Ny_Time_End_Pr(void);
/********************************************************
* 切换表尾电压端子  处理 
* 0:接入3号端子 1:接入1号端子 
********************************************************/
void Chg_U_In_Pr(void);
/********************************************************
* 误差校验指示灯控制命令  处理 
********************************************************/
void STS_Light_Pr(void);
/********************************************************
* 接收失压相别
********************************************************/
void Set_Sy_Ph(void);                 
/********************************************************
* 设置最小电表常数
********************************************************/
void Set_Min_CST_Pr(void);            
/********************************************************
* 接收校核常数走字度数 
********************************************************/
void Set_ZZ_Ds(void);                      
/********************************************************
* 接收失压方案
********************************************************/
void Set_Sy(void);                    
/********************************************************
* 设置多功能脉冲方式
* '1' UNION_PLS 联合多功能脉冲 时钟 需量 投切 等共用
* '2' ALONE_PLS 独立多功能脉冲 时钟 需量 投切 分开输入         
********************************************************/
void Set_MFCLK_Mode(void);
/********************************************************
* 设置当前多功能脉冲输入类型
* 只有在联合脉冲输入方式下有效
* SZCLK_PLS    '1'      当前输入为时钟脉冲
* XULCLK_PLS   '2'      当前输入为需量脉冲
* TQCLK_PLS    '3'      当前输入为投切脉冲
********************************************************/
void Set_MFCLK_Type(void);
/********************************************************
* 设置电子脉冲输入 PA PR QA QR 调试用 
* 只有在电子脉冲输入方式下有效
* PA_PLS           '1'      //正向有功
* PR_PLS           '2'      //反向有功
* QA_PLS           '3'      //正向无功
* QR_PLS           '4'      //反向无功
********************************************************/
void Set_Elec_Pls(void);
/********************************************************
* 继电器吸合  处理 
********************************************************/
void Relay_Close_Pr(void);
/********************************************************
* 继电器断开  处理 
********************************************************/
void Relay_Open_Pr(void);           
/********************************************************
* 电流回路开路检测  处理 
********************************************************/
void I_Open_Tst_Pr(void); 
/********************************************************
* 设置最小电表常数  处理 
********************************************************/
void Set_Min_CST_Pr(void);
/********************************************************
* 挂表模式处理
********************************************************/
void MTR_PLUG_MODE_Pr(void);     
/********************************************************
* 对黑斑模式处理
********************************************************/
void CATCH_HB_MODE_Pr(void);     
/********************************************************
* 启动 潜动模式下 监视电能脉冲计数
********************************************************/
void START_STOP_MODE_Pr(void);    
/********************************************************
* 准备开始走字模式 继电器吸合
********************************************************/
void ZZ_READY_MODE_Pr(void);     
/********************************************************
* 走字试验模式
********************************************************/
void ZZ_START_MODE_Pr(void);    
/********************************************************
* 电压跌落试验模式
********************************************************/
void VOLTAGE_DOWN_MODE_Pr(void); 
/********************************************************
* //进入计电能试验 计量被检表电能
********************************************************/
void MEASURE_ENG_MODE_Pr(void);        
/********************************************************
* //进入盘转误差试验
********************************************************/
void PANZHUAN_ERR_MODE_Pr(void);       
/********************************************************
* //常数测试试验
********************************************************/
void MEA_CST_MODE_Pr(void);            
/********************************************************
* //功耗测量试验
********************************************************/
void MEA_POWER_D_MODE_Pr(void);        
/********************************************************
* //测量电能脉冲周期和占空比
********************************************************/
void MEA_ENG_DUTY_MODE_Pr(void);       
/********************************************************
* //定脉冲走字试验
********************************************************/
void PULSE_ZZ_MODE_Pr(void);           
/********************************************************
* //耐压试验 并记录耐压状态下脉冲状态
********************************************************/
void NYSY_MODE_Pr(void);               
/********************************************************
* 误差计算板工作模式处理
********************************************************/
void Work_Mode_Pr(void); 
/*****************************************************************************
* AD采样定时超时处理
*****************************************************************************/
void Proc_ADC_Timer(void);
/********************************************************
* 初始化设备测量IO口
* GDT_PLS          '1'      //光电头脉冲
* DZ_PLS           '2'      //电子脉冲
* SZ_PLS           '3'      //时钟脉冲
* XUL_PLS          '4'      //需量脉冲
* TQ_PLS           '5'      //投切脉冲
* HZ_PLS           '6'      //合闸脉冲
********************************************************/
void Init_DEVICE_IO(void);
/******************************************************
* 设置RS485 第二通道     
* '1' 接表485第二通道
* '2' 接表红外 
******************************************************/
void Set_Red485(void);
/******************************************************
* 读版本号    
******************************************************/
void Set_Read_Ver(void);             
/******************************************************
* 设置表位电压接入 断开     
******************************************************/
void Set_UCLOP(void);
/******************************************************
* 读小显示工作状态    
******************************************************/
void Set_RSTS(void);
/******************************************************
* 根据表类型对脉冲选择进行处理
* 电子脉冲  时钟脉冲 输入互换   
******************************************************/
void Proc_MTYPE(void);
/******************************************************
* 选择表类型 国网表 'N'  南网表'S'  
* 电子脉冲  时钟脉冲 输入互换   
******************************************************/
void Set_MTYPE(void);
/*****************************************************************************
* 载表试验
*****************************************************************************/
void Set_ZBTST(void);
/*****************************************************************************
* 试验状态
*****************************************************************************/
void Set_Light(void);
/******************************************************
* 设置误差板LED位数 
* SLEDN:6  6位数码管
* SLEDN:8  8位数码管
******************************************************/
void Set_SLEDN(void);
/******************************************************
* 设置载波虚拟表电压接入相别
******************************************************/
void Set_VSET(void);
/******************************************************
* 设置接入UART0的通讯方式    
******************************************************/						
void Set_COM0SEL(void);
/******************************************************
* 设置接入UART1的通讯方式
******************************************************/
void Set_COM1SEL(void);
/******************************************************
* 载波滤波电路接入选择
******************************************************/
void Set_ZBLBIN(void);
/******************************************************
* 遥信信号控制命令
******************************************************/          
void Set_YXCTL(void);
/******************************************************
* 门控信号控制命令
******************************************************/              
void Set_DOORCTL(void);
/******************************************************
* 检测设备类型设置
******************************************************/
void Set_EQPMOD(void);              
/******************************************************
* 脉冲参数设置命令(针对专变终端)
******************************************************/							
void Set_PULSET(void);
/******************************************************
* 脉冲输出运行设置命令(针对专变终端)
******************************************************/							
void Set_PULRUN(void);
/******************************************************
* 脉冲输出个数设置命令(针对专变终端)
******************************************************/							
void Set_PULNUM(void);
/******************************************************
* 终端遥控信号设置
******************************************************/							
void Set_YKSET(void);        
/******************************************************
* 设置遥控信号脉冲触发方式
******************************************************/							     
void Set_YKPULSE(void);
/******************************************************
* 无极性RS485测试
******************************************************/
void Set_NPRS485(void);
/******************************************************
* 直流12V测量控制
******************************************************/
void Set_ADCONV(void);
/******************************************************
* 设置双回路校验台 电流接入主副回路
* TTAB:A(0DH) A=1 电流接入副回路 A=2 电流接入主回路
******************************************************/
void Set_TTAB(void);
/******************************************************
* 并行功耗测试控制
******************************************************/
void Set_MEAPN(void);
/******************************************************
* 并行功耗各项测试数据查询
******************************************************/
void Set_CHKP(void);



